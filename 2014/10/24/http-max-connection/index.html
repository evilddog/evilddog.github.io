<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>浅谈浏览器最大并发连接数问题 | evilddog&#39;s blog</title>
  <meta name="author" content="evilddog">
  
  <meta name="description" content="be quieter">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="浅谈浏览器最大并发连接数问题"/>
  <meta property="og:site_name" content="evilddog&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  

</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">evilddog&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> 浅谈浏览器最大并发连接数问题</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

			

	<!-- content -->
	<div class="mypage">		
	    <p> 偶然刷知乎刷到一个无人关注，无人回答的<a href="http://www.zhihu.com/question/22935511" target="_blank" rel="external">问题</a>,然后觉得自己答不上来(逃</p>
<p>于是转向度娘和谷歌,觉得看起来简单的问题牵扯到到东西挺多的,便一边查一边记下来</p>
<p><a id="more"></a></p>
<p><hr></p>
<h2 id="首先说一说HTTP的短链接和长连接">首先说一说HTTP的短链接和长连接</h2>
<p>一个典型的网页，是由一个HTML文件和内嵌的各类元素组成的，这些元素包括页面内的图片，CSS文件，Javascript 文件等等。每一个内嵌的元素在 HTTP 协议的层面上任何一个文件是没有区别的,都需要浏览器去服务器上传输过来。</p>
<p>一个早期典型的浏览器是这样实现的：当用户敲入网址之后，浏览器和服务器建立连接<del>中间的DSN请求和本地缓存以及SSL不是本文的重点</del>，请求这个HTML页面，然后边接收服务器发送的HTML页面，边解析，碰到内嵌元素，可以立即开第二条连接请求。</p>
<p>另外，如果内嵌元素很多，他可能会开多条连接同时请求。当所有需要的元素都下载完毕之后，浏览器就会将页面画出来。这个过程就是最早期的 HTTP/1.0 协议所设想的浏览器实现。</p>
<p>HTTP/1.0 这种多连接的运作模式是可以改进的。在TCP传输中客户端和服务器要发送三次握手包才能建立TCP连接。连接建立之后，浏览器给服务器发请求，服务器给浏览器回应。之后又会要传输几个网络包关闭TCP连接。</p>
<p>如果页面有很多文件长度很短的元素，每个元素都需要单建一条连接就会导致网络上大量的都是 TCP 建立连接和断开连接的网络包。另外，TCP有一个特性叫做 <a href="http://blog.csdn.net/great3779/article/details/6578033" target="_blank" rel="external">slow start</a>，其含义可以大致这样解释：<strong>TCP连接要求发送端发送一定数量的网络包之后接收端就要回一个”Get it”的网络包，而且网络包在经过每个路由器的时候包头都要被重写，所以在网络不丢包的情况下网络包越大网络的效率就越高。</strong></p>
<p>TCP 连接寻找最优网络包大小的方法是，在 TCP连接建立的初期，网络包的大小是很小的，根据网络状况，两端的程序才会逐步增大网络包的大小以适应带宽提高网络传输的效率。所以浏览器给服务器发请求，如果每发一个请求就关闭连接的话，那这个连接的数据传输很难达到带宽所能承载的速度。慢启动其实也是为什么在下载文件过程中传输速度是先缓慢上升的原因。<br><br><br><b>所以！！！！！！！！！！</b><br><br></p>
<h4 id="_HTTP/1-1_开始提出了持久连接(Persistent_Connection)的概念，也就是说同一条_HTTP连接，可以依次处理多个请求，同时用一定的机制保证各个请求之间的分离性。具体的操作过程是：服务器给浏览器发送回应之后，并不马上关闭连接;浏览器判断上一个请求的回应已经收完的情况下，可以在这同一个连接上发第二个请求。"><strong> HTTP/1.1 开始提出了持久连接(Persistent Connection)的概念，也就是说同一条 HTTP连接，可以依次处理多个请求，同时用一定的机制保证各个请求之间的分离性。具体的操作过程是：服务器给浏览器发送回应之后，并不马上关闭连接;浏览器判断上一个请求的回应已经收完的情况下，可以在这同一个连接上发第二个请求。</strong></h4>
<h4 id="_这种运作模式大大减少了网络包，实验也表明这种做法很有效。但是，由于服务器上保持连接要占用一定的资源，所以一般服务器不会永久保持持久连接，而且也不推荐浏览器和服务器之间建立过多的持久连接。"><strong> 这种运作模式大大减少了网络包，实验也表明这种做法很有效。但是，由于服务器上保持连接要占用一定的资源，所以一般服务器不会永久保持持久连接，而且也不推荐浏览器和服务器之间建立过多的持久连接。</strong></h4>
<p><br><br><em><del>WTF,这东西又臭又长说起来太费劲,但又必须说清楚</del></em> <img src="http://evilddog.qiniudn.com/xianzhuo.jpg" alt=""></p>
<h3 id="接下来是正片_=_=">接下来是正片   = =</h3>
<p><br><br><strong>HTTP协议与TCP/IP协议</strong></p>
<p>HTTP的长连接和短连接本质上是TCP长连接和短连接。HTTP属于应用层协议，在传输层使用TCP协议，在网络层使用IP协议。</p>
<p><br></p>
<p><strong>HTTP协议是无状态的</strong></p>
<p>HTTP协议的无状态指的是协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。HTTP是一个无状态的面向连接的协议，无状态不代表HTTP不能保持TCP连接，更不能代表HTTP使用的是UDP协议。</p>
<p><br></p>
<p><strong>什么是短连接</strong></p>
<p>client向server发起连接请求，server接到请求，然后双方建立连接。client向server 发送消息，server回应client，然后一次读写就完成了。从上面的描述看，短连接一般只会在 client/server间传递一次读写操作。</p>
<p><br></p>
<p><strong>TCP长连接：</strong></p>
<p>链接建立之后，如果应用程序或者上层协议一直不发送数据，或者隔很长时间才发送一次数据，当链接很久没有数据报文传输时如何去确定对方还在线，到底是掉线了还是确实没有数据传输.</p>
<p>TCP协议通过一种巧妙的方式去解决这个问题，当超过一段时间之后，TCP自动发送一个数据为空的报文给对方，如果对方回应了这个报文，说明对方还在线，链接可以继续保持，如果对方没有报文返回，并且重试了多次之后则认为链接丢失，没有必要保持链接。</p>
<p><br></p>
<p><strong>HTTP长链接：</strong></p>
<p>其实HTTP的长连接和TCP的长连接完全不一样。HTTP层的Keep-Alive是什么概念呢？<br>TCP在建立链接之后， HTTP协议使用TCP传输HTTP协议的请求(Request)和响应(Response)数据，一次完整的HTTP事务如下图(实际上的请求和响应需要多个TCP报文)：<img src="http://images.cnitblog.com/i/592959/201407/170853222245220.jpg" alt=""></p>
<p>从图中可以发现一个完整的HTTP事务，有链接的建立，请求的发送，响应接收，断开链接这四个过程,早期通过HTTP协议传输的数据以文本为主，一个请求可能就把所有要返回的数据取到，但是，现在要展现一张完整的页面需要很多个请求才能完成，如图片,JS,CSS等，如果每一个HTTP请求都需要新建并断开一个TCP，这个开销是完全没有必要的。</p>
<p>开启HTTP Keep-Alive之后，能复用已有的TCP链接，当前一个请求已经响应完毕，服务器端没有立即关闭TCP链接，而是等待一段时间接收浏览器端可能发送过来的第二个请求，通常浏览器在第一个请求返回之后会立即发送第二个请求，如果某一时刻只能有一个链接，同一个TCP链接处理的请求越多，开启KeepAlive能节省的TCP建立和关闭的消耗就越多。</p>
<p>当然通常会启用多个链接去从服务器器上请求资源，但是开启了Keep-Alive之后，仍然能加快资源的加载速度。HTTP/1.1之后默认开启Keep-Alive, 在HTTP的头域中增加Connection选项。当设置为Connection:keep-alive表示开启，设置为Connection:close表示关闭。实际上HTTP的KeepAlive写法是Keep-Alive，跟TCP的KeepAlive写法上也有不同。所以TCP的KeepAlive和HTTP的Keep-Alive不是同一回事情。</p>
<p><br></p>
<p><hr></p>
<h2 id="然后是浏览器的并发连接数问题">然后是浏览器的并发连接数问题</h2>
<p>每款浏览器都有自己的默认并发连接数，而且浏览器默认对同一域下的资源，只保持一定的连接数，会阻塞过多的连接，这都会影响到浏览器对网页的加载速度。</p>
<p>这个限制，对于普通的Web应用来讲，影响不算太大，毕竟正常的连接请求都会很快有返回结果的，但如果在Web中要是用长连接的话，就可能会有比较大的问题了，长连接会一直占用一个连接数。</p>
<p><hr></p>
<h4 id="那么，最大化提高浏览器的并发连接数不好么？"><strong>那么，最大化提高浏览器的并发连接数不好么？</strong></h4>
<p>当然不是,首先我们了解一下浏览器怎么并发连接数的：</p>
<pre><code><span class="bullet">1. </span>浏览器发出请求。
<span class="bullet">2. </span>DNS进行解析。
<span class="bullet">3. </span>服务器返回请求内容。
<span class="bullet">4. </span>浏览器按顺序分析获取的内容，并且依次获取页面的外链css、外链js、img等，一个下载完再下载下一个。
</code></pre><p>所以并发连接数的增加对一个域名同时并发请求数达到了多个，这样浏览器就可以同时下载js，css，img了，一般情况下，堵塞的现象就很少了。<br><br><br>如下是各种主流浏览器的默认最大并发连接数:<img src="http://evilddog.qiniudn.com/http-keep-alive.png" alt=""><br>W3C 的 <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.1.4" target="_blank" rel="external">HTTP/1.1协议</a> 中提到，如果是相同域名下的请求，就会有限制，只能保持一定数量。同样，<a href="https://developer.yahoo.com/performance/rules.html" target="_blank" rel="external">Yahoo!关于网站优化的经典建议</a>中提到“要减少请求数”和“减少 DNS 解析次数”，而这就和我们网站的做法相违背了。这就需要在提高并发连接数和减少DNS解析之间找到个完美的平衡点了</p>
<p>不过很多时候我们为了效率还想得到更高的并发连接数，比如说我们总会看到一些大网站采用独立域名或者二级域名来设置专门的图片服务器，其实有一部分原因就 是为了增加并发连接数。至于使用独立域名还是二级域名的差别在于Cookie的影响，当使用和主站根域名相同的二级域名时，请求的同时也会捎带着传递主站根域名的Cookie，而使用和主站根域名不同的独立域名时，则不会受主站根域名Cookie的影响，所以带宽占用会更小一些。</p>
<p><hr></p>
<h2 id="DNS服务器这些东西关我屁事，我只想下载速度快点">DNS服务器这些东西关我屁事，我只想下载速度快点</h2>
<p>虽然各主流浏览器的最大并发连接数默认都小于10，不过都是可以更改的</p>
<p>但是在下载文件的时候,如果有很多keep-alive的连接存在，肯定会慢的1B，当然这些参数都是可以修改的，比如IE浏览器的<a href="http://support2.microsoft.com/?kbid=282402" target="_blank" rel="external">官方文档</a>，火狐浏览器的<a href="about:config" target="_blank" rel="external">配置如下</a></p>
<p><img src="http://evilddog.qiniudn.com/firefox.png" alt=""></p>
<p>但是实际上天朝人民的HTTP传输的连接并发数 <strong>60%都是大于8的</strong></p>
<p>原因就是国内迅雷，暴风影音，快车，QQ旋风等多线程下载器的流行，这也是为什么在进行大流量文件传输过程时下载器的速度要远比浏览器要快的主要原因，当然还有带宽等其他因素影响</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/2014/10/28/nmap-1/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2014/10/13/same-origin-policy/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">留言</h2>

  
</section>

	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	10月 24 2014 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="//categories/HTTP/">HTTP<span>3</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="//tags/HTTP/">HTTP<span>2</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2014 evilddog
  
      with help from <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
